<script>
// 마우스 우클릭 방지
document.addEventListener('contextmenu', event => event.preventDefault());

// F12 및 개발자도구 단축키 방지
document.addEventListener('keydown', function (event) {
  if (
    event.key === 'F12' ||
    (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'J' || event.key === 'C')) ||
    (event.ctrlKey && event.key === 'U')
  ) {
    event.preventDefault();
    alert("이 기능은 사용할 수 없습니다.");
  }
});

if (sessionStorage.getItem("authenticated") !== "true") {
  window.location.href = "index.html";
}

// 기존 기능들 계속 유지
function checkPassword() {
  const input = document.getElementById('pw').value;
  if (input === "") {
    document.getElementById('auth').style.display = 'none';
    document.getElementById('page').style.display = 'flex';
    const generalBtn = [...document.querySelectorAll('.tab-btn')].find(btn => btn.textContent.includes("일반검색"));
    if (generalBtn) switchTab('generalTab', generalBtn);
  } else {
    document.getElementById('error').innerText = "비밀번호가 틀렸습니다.";
  }
}

let generalData = [], discountData = [], agencyData = [];

function highlight(text, keyword) {
  if (!keyword) return text;
  return String(text).replace(new RegExp(keyword, "gi"), match => '<mark>' + match + '</mark>');
}

function renderTable(data, keyword, headId, bodyId, noResultId) {
  const thead = document.getElementById(headId);
  const tbody = document.getElementById(bodyId);
  const noResults = document.getElementById(noResultId);
  const filtered = data.filter(row =>
    !keyword || Object.values(row).some(v =>
      String(v || "").toLowerCase().includes(keyword.toLowerCase())
    )
  );
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (keyword && filtered.length === 0) {
    noResults.style.display = "block";
    return;
  } else {
    noResults.style.display = "none";
  }

  if (!filtered.length) return;

  const headers = Object.keys(filtered[0]);
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";

  let greenStartIndex = -1;
  let greenEndIndex = -1;
  if (headId === "discountHead") {
    const lowerHeaders = headers.map(h => h.toLowerCase());
    greenStartIndex = lowerHeaders.findIndex(h => h.includes("일반왕복"));
    greenEndIndex = lowerHeaders.findIndex(h => h.includes("크리편도"));
  }

  filtered.forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      td.innerHTML = highlight(row[h], keyword);
      if (headId === "discountHead" && greenStartIndex !== -1 && greenEndIndex !== -1) {
        const colIndex = headers.indexOf(h);
        if (colIndex >= greenStartIndex && colIndex <= greenEndIndex) {
          td.classList.add("green-cell");
        }
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function searchGeneral() {
  const keyword = document.getElementById("generalSearch").value.trim();
  renderTable(generalData, keyword, "generalHead", "generalBody", "generalTabNoResults");
}
function searchDiscount() {
  const keyword = document.getElementById("discountSearch").value.trim();
  renderTable(discountData, keyword, "discountHead", "discountBody", "discountTabNoResults");
}
function searchAgency() {
  const keyword = document.getElementById("agencySearch").value.trim();
  renderTable(agencyData, keyword, "agencyHead", "agencyBody", "agencyTabNoResults");
}

function switchTab(tabId, el) {
  document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
  document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
  document.getElementById(tabId).style.display = "block";
  el.classList.add("active");
}

window.onload = () => {
  Promise.all([
    fetch("일반검색.json").then(res => res.json()).then(data => generalData = data),
    fetch("할인명검색.json").then(res => res.json()).then(data => discountData = data),
    fetch("여행사검색.json").then(res => res.json()).then(data => agencyData = data)
  ]).then(() => {
    searchGeneral();
    searchDiscount();
    searchAgency();
  });
};
</script>
